<!DOCTYPE HTML>
<html>
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel='icon' href='img/favicon.ico' type='image/x-icon' sizes="16x16" />
    <title>Simple Latex Printer</title>

    <link href="css/bootstrap.css" rel="stylesheet" media="all">
    <link href="css/main.css" rel="stylesheet" media="all">

    <script src="js/jquery.min.js"></script>

  </head>

  <body>

    <div class="page-wrapper bg-gra-02 p-t-130 p-b-100 font-poppins">
      <div class="wrapper wrapper--w960">
          <div class="card card-4">
              <div class="card-body">
                  <h2 class="title">Latex Printer</h2>

                      <div class="row row-space">
                        <button id="compile" class="btn btn--red btn--radius">Print </button>                
                        <div class="tab" id="tab_open_pdf" style="display: none">
                          <h4>Compiled PDF</h4>
                          <br>
                          <a id='pdf-file-link' download='compiled_latex.pdf' style="display:none;"></a>
                          <button class="btn btn--gray btn--radius" id="open_pdf_btn">Download PDF</button>
                        </div>
                      </div>

                      <a name="running" id="running" style="display: none">
                        Compilingâ€¦
                        <img src="img/loading.gif" />
                      </a>

                      <br>

                      <div class="row row-space">
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text input--style-4">Latex Code</span>
                          </div>
                          <textarea class="form-control" id="latex-code" aria-label="Latex content"></textarea>
                        </div>
                      </div>

                      <div class="row row-space">
                        <h5>Load circuit image (Optional)</h5>
                        <br>
                        <input type="file" id="files" />
                      </div>

                      <br>

                      <div class="row row-space">
                        <div id="output" style="background-color:#ffffff; color:#c1c1c1;border-style: dotted; padding: 25px 25px 25px 25px; display:none;"></div>
                      </div>

              </div>
          </div>
      </div>
  </div>



      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.min.js"></script>
      <script src="js/jquery.easing.min.js"></script>

      <script src="vendor/promisejs/promise.js"></script>
      <script src="vendor/pdftex/pdftex.js"></script>
      <script src="js/base64data.js"></script>
      <script src="js/latexsample.js"></script>
      <script src="js/b64-worker-data.js"></script>

      <script>

        // Inject sample tex to latex code text area
        function parseData(data){
          $('#latex-code').val(data);
          $('#latex-code').attr('rows', 20);
          $('#latex-code').css("background-color", "#ebebeb");
        }

        $.get("sample.tex",parseData);

        // Circuit image to send
        var sendData = "";
        var input = document.getElementById("files"),
        output = document.getElementById('output');

        function getFileUrl() {
          var preview = document.querySelector('img');
          var file    = document.querySelector('input[type=file]').files[0];
          var reader  = new FileReader();

          reader.addEventListener("load", function () {
            //preview.src = reader.result;
            sendData = reader.result;
          }, false);

          if (file) {
            reader.readAsDataURL(file);
          }
        }

        // Eventlistener for file input.
        input.addEventListener('change', getFileUrl, false);

        var visibilityChanger = function(element_id) {
          return function(visible) {
            document.getElementById(element_id).style.display = visible ? 'block' : 'none';
          }
        }

        var showLoadingIndicator = visibilityChanger("running")
        var showOpenButton = visibilityChanger("tab_open_pdf")

        var appendOutput = function(msg) {
          var output = document.getElementById("output");

          var content = output.textContent;

          output.textContent = content + "\r\n" + msg;

          output.scrollTop = 999999;
          console.log(msg);
        }

        var pdf_dataurl = undefined;
        var compile = function(source_code) {
        document.getElementById("output").textContent = "";
        showLoadingIndicator(true);
        window.location.href = "#running";

        var img1 = base64imgselect("img1");
        var img2 = base64imgselect("img2");
        var logo = base64imgselect("logo");

        var pdftex = new PDFTeX();

        pdftex.set_TOTAL_MEMORY(80*1024*1024).then(function() {

          // Add image files
          if(sendData == "") sendData = base64imgselect("circuit");

          pdftex.FS_createLazyFile('/', 'circuit.jpg', sendData, true, true);
          pdftex.FS_createLazyFile('/', 'snf1.png', img1, true, true);
          pdftex.FS_createLazyFile('/', 'snf2.png', img2, true, true);
          pdftex.FS_createLazyFile('/', 'logo.png', logo, true, true);

          pdftex.on_stdout = appendOutput;
          pdftex.on_stderr = appendOutput;

          console.time("Execution time");

          pdftex.compile(source_code).then(function(pdf_dataurl) {
            console.timeEnd("Execution time");

            showLoadingIndicator(false);

            if (pdf_dataurl === false)
              return;

            showOpenButton(true);
            window.location.href = "#open_pdf";
            document.getElementById("open_pdf_btn").focus();
            });
          });
        }

        document.getElementById("compile").addEventListener("click", function(e) {
          //var source_code = getlatexsample();
          var source_code = document.getElementById("latex-code").value;
          compile(source_code);
        });

        document.getElementById("open_pdf_btn").addEventListener("click", function(e) {
          var dlnk = document.getElementById('pdf-file-link');
          dlnk.href = pdf_dataurl;

          dlnk.click();
          e.preventDefault();
        });

        //var pdftex_preload = new PDFTeX("vendor/pdftex/pdftex-full-worker.js");
        //pdftex_preload = undefined;
    </script>
  </body>
</html>